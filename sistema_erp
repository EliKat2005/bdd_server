-- 1. PREPARACIÓN
CREATE DATABASE IF NOT EXISTS consultoria_erp;
USE consultoria_erp;

-- 2. TABLAS CATÁLOGO (Sin dependencias)
CREATE TABLE roles (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE clientes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    empresa VARCHAR(100) NOT NULL,
    contacto_nombre VARCHAR(100),
    email VARCHAR(100),
    telefono VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL
);

-- 3. TABLAS PRINCIPALES
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    rol_id INT NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL, -- Simulado
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,
    FOREIGN KEY (rol_id) REFERENCES roles(id)
);

CREATE TABLE proyectos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT NOT NULL,
    lider_id INT NOT NULL, -- Usuario líder del proyecto
    nombre VARCHAR(150) NOT NULL,
    presupuesto DECIMAL(10,2),
    fecha_inicio DATE,
    fecha_fin DATE,
    estado ENUM('Planificacion', 'En Curso', 'Finalizado', 'Cancelado') DEFAULT 'Planificacion',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,
    FOREIGN KEY (cliente_id) REFERENCES clientes(id),
    FOREIGN KEY (lider_id) REFERENCES usuarios(id)
);

CREATE TABLE facturas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT NOT NULL,
    proyecto_id INT,
    monto_total DECIMAL(10,2) NOT NULL,
    fecha_emision DATE NOT NULL,
    estado ENUM('Pendiente', 'Pagada', 'Anulada') DEFAULT 'Pendiente',
    FOREIGN KEY (cliente_id) REFERENCES clientes(id),
    FOREIGN KEY (proyecto_id) REFERENCES proyectos(id)
);

-- 4. TABLAS OPERATIVAS (Dependencias profundas)
CREATE TABLE fases (
    id INT AUTO_INCREMENT PRIMARY KEY,
    proyecto_id INT NOT NULL,
    nombre VARCHAR(100) NOT NULL, -- Ej: "Levantamiento de Req"
    orden INT DEFAULT 1,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos(id) ON DELETE CASCADE
);

CREATE TABLE tareas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    fase_id INT NOT NULL,
    asignado_a INT, -- Usuario responsable
    descripcion TEXT NOT NULL,
    prioridad ENUM('Baja', 'Media', 'Alta', 'Urgente') DEFAULT 'Media',
    estado ENUM('Pendiente', 'En Progreso', 'Completada') DEFAULT 'Pendiente',
    due_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,
    FOREIGN KEY (fase_id) REFERENCES fases(id),
    FOREIGN KEY (asignado_a) REFERENCES usuarios(id)
);

CREATE TABLE bitacora_tiempo (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tarea_id INT NOT NULL,
    usuario_id INT NOT NULL,
    horas DECIMAL(4,2) NOT NULL,
    fecha DATE NOT NULL,
    comentario VARCHAR(255),
    FOREIGN KEY (tarea_id) REFERENCES tareas(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- 5. DATOS SEMILLA (SEEDING)
INSERT INTO roles (nombre) VALUES ('Administrador'), ('Gerente de Proyecto'), ('Consultor Senior'), ('Desarrollador');

INSERT INTO usuarios (rol_id, nombre, email, password_hash) VALUES 
(1, 'Admin Sistema', 'admin@erp.local', 'hash123'),
(2, 'Ing. Supervisora', 'jefa@erp.local', 'hash123'),
(4, 'Dev Junior', 'dev@erp.local', 'hash123');

INSERT INTO clientes (empresa, contacto_nombre, email) VALUES 
('Banco del Pichincha', 'Lic. Finanzas', 'pagos@pichincha.com'),
('Supermaxi', 'Gerente Compras', 'compras@favorita.com');
